# kubernetes securityContext 容器安全详解

kubernetes Deployment securityContext, securityContext 是 kubernetes 中用来配置 pod 和 容器安全属性的关键字段，它可以设置在 Pod 级别 和 容器级别

# linux UID 基础知识

linux 系统中每个用户都有一个唯一的数字表示
root 用户的 UID 是 0 
普通用户的 UID 通常是从 1000 开始
系统用户的 UID 通常是 1-999

容器内的所有进程都以 UID = 1000 运行 
这个用户 不是 root  , root 的 UID 为 0
权限受到限制，增强安全性 

# linux GID 基础知识

linux 系统中每个组都有一个唯一的数字标识
root 组的 GID 是 0
普通组的 GID 通常从 1000 开始 



一， securityContext 的作用层次

# yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: security-demo
spec:
  replicas: 3
  selector:
    matchLabels:
      app: security-demo
  template:
    metadata:
      labels:
        app: security-demo
    spec:
      # ==================== Pod 级别的 securityContext =======================
      securityContext:
        runAsUser: 1000     # 以普通用户运行， root 用户的 UID 为 0 而普通用户的 UID 从 1000 开始  
        runAsGroup: 3000
        fsGroup: 2000
        seccompProfile:
          type: RuntimeDefault
        seLinuxOptions:
          level: "s0:c123,c456"
    containers:
    - name: nginx
      image: nginx:1.21
      # =================== 容器级别的 securityContext ==========================
      securityContext:
        allowPrivilegeEscalation: false 
        runAsUser: 1000  # 以普通用户运行 ， root 用户的 UID 为 0
        runAsNonRoot: true # 不能以 root 用户运行 
        capabilities: 
          drop:
            - ALL 
          add:
            - NET_BIND_SERVICE
        readOnlyRootFilesystem: true 
        privileged: false 


# Pod 级别的 SecurityContext 

1, runAsUser / runAsGroup - 用户和组 ID 

# yaml 

spec:
  securityContext:
    runAsUser: 1000    # 指定运行用户 ID  UID 以普通用户运行 
    runAsGroup: 3000   # 指定运行组 ID GID 

# fsGroup - 文件系统组
# yaml 
spec:
  securityContext:
    fsGroup: 2000
    # 所有挂载卷的文件组ID会被改为 2000
    # 容器对卷有读写权限 

# selinuxOptions - SeLinux 配置
# yaml 
sepc:
  securityContext:
    seLinuxOptions:
      level: "s0:c123,c456"
      # 设置 selinux 安全上下文
      # type: container_t  # 也可以设置 type 

三, 容器级别的 securityContext 
1, privileged - 特权模式

# yaml 
containers:
- name: container 
  securityContext:
    privileged: true # 很危险 容器拥有主机 root 权限 
                     # 允许访问所有设备，执行特权操作 


2, allowPrivilegeEscalation - 特权升级 

# yaml 
securityContext:
  allowPrivilegeEscalation: false    # 推荐， 禁止特权升级 
                                     # 防止通过 suid 二进制文件提升权限 


示例 ： 安全的生产环境部署 

# yaml 

apiVersion: apps/v1
kind: Deployment
metadata:
  name: secure-webapp
  labels:
    app: secure-webapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: secure-webapp
  template:
    metadata:
      labels:
        app: secure-webapp
    spec:
      # ================ Pod 安全配置 ===================
      securityContext:
        runAsUser: 1000   # 非特权用户 
        runAsGroup: 3000  # 特定组
        fsGroup: 2000     # 卷文件组 
        seccompProfile:
          type: RuntimeDefault    # 安全计算模式 

    serviceAccountName: webapp-sa 
    automountServiceAccountToken: false   # 不自动挂载Token 

    containers:
    - name:
      iamges: myregistry/webapp:v1.2.3

      # =================== 容器安全配置 =====================
      securityContext:
        allowPrivilegeEscalation: false   # 禁用特权升级 
        privileged: false    # 非特权容器 
        readOnlyRootFilesystem            # 只读根文件系统
        runAsNonRoot: true                # 非 root 用户运行 
        runAsUser: 1000                   # 明确指定用户 

        # linux 能力管理
        capabilities: 
          drop: ["ALL"]                   # 删除所有能力 
          add: ["NET_BIND_SERVICE"]       # 只添加必需能力 

        # 资源限制 
        resource:
          requests:
            memory: "64Mi"
            cpu: "250m"
          limits:
            memory: "128Mi"
            cpu: "500m"

        # 只读挂载点
        volumeMounts:
        - name: app-config 
          mountPath: /etc/app/config 
          readOnly: true 
        - name: tmp-volume 
          mountPath: /tmp 
        - name: log-volume 
          mountPath: /var/log/app 

        # 健康检查 
        livenessProbe:
          httpGet:
            path: /healthz 
            port: 8080
          initialDeplaySeconds: 30
          periodSeconds: 10

       readinessProbe:
         httpGet:
           path: /ready 
           port: 8080
        initialDeplaySeconds: 5
        periodSeconds: 5
    # 卷定义
    volumes:
    - name: app-config 
      configMap:
        name: app-config 
    - name: tmp-volume 
      emptyDir: {}
    - name: log-volume 
      emptyDir: {}
      
